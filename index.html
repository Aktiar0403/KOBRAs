<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Squad Members ‚Äì Admin Pro Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#050816;
  --card:#0b1020;
  --accent:#22c55e;
  --accent-soft:#4ade80;
  --danger:#ef4444;
  --text:#f9fafb;
  --muted:#9ca3af;
  --border:#1f2933;
  --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Arial;
  background:radial-gradient(circle at top,#111827,#020617);
  color:var(--text);
}

/* LOGIN */
#loginScreen{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(circle at top,#020617,#020617);
  z-index:9999;
}
.login-box{
  background:var(--card);
  border-radius:18px;
  border:1px solid var(--border);
  padding:20px 18px 16px;
  max-width:320px;
  width:100%;
  box-shadow:0 20px 45px rgba(0,0,0,.6);
}
.login-box h2{
  margin:0 0 8px;
  font-size:1.2rem;
}
.login-box p{
  margin:0 0 12px;
  font-size:.8rem;
  color:var(--muted);
}
.login-box input{
  width:100%;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#020617;
  color:white;
  font-size:.85rem;
  margin-bottom:8px;
}
.login-box button{
  width:100%;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--accent);
  background:#022c22;
  color:var(--accent-soft);
  cursor:pointer;
  font-size:.85rem;
}
.login-error{
  color:var(--danger);
  font-size:.78rem;
  min-height:16px;
}

/* APP */
#app{display:none}
.container{
  max-width:1500px;
  margin:auto;
  padding:20px;
}
h1{margin:0 0 4px;font-size:1.8rem}
.subtitle{font-size:.8rem;color:var(--muted);margin-bottom:6px}
.userline{font-size:.78rem;color:var(--muted);margin-bottom:12px}

/* Controls */
.top-controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.btn{
  background:var(--card);
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 14px;
  border-radius:999px;
  font-size:.75rem;
  cursor:pointer;
}
.btn.success{border-color:var(--accent);color:var(--accent-soft)}
.btn.danger{border-color:var(--danger);color:var(--danger)}
.btn.secondary{border-color:#4b5563;color:#e5e7eb}
.btn:hover{background:#111936}

/* Stats */
.stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.stat{
  background:var(--card);
  border:1px solid var(--border);
  padding:8px 14px;
  border-radius:999px;
  font-size:.8rem;
}

/* Filters & search & sort */
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.search-box{margin-bottom:10px}
.search-box input{
  width:100%;
  max-width:320px;
  padding:8px 16px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#020617;
  color:white;
  font-size:.85rem;
}
.sort-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}

/* Layout: cards + audit */
.main-layout{
  display:grid;
  grid-template-columns:minmax(0,3.2fr) minmax(260px,1fr);
  gap:16px;
  align-items:flex-start;
}
@media(max-width:960px){
  .main-layout{grid-template-columns:1fr}
}

/* Cards */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
  gap:14px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.name{font-weight:600;font-size:.95rem}
.meta{font-size:.75rem;color:var(--muted)}
.power{font-weight:700;font-size:1.1rem;color:#a5b4fc}
.stars{letter-spacing:2px;font-size:.9rem}
.stars[data-score="5"]{color:#22c55e}
.stars[data-score="4"]{color:#a3e635}
.stars[data-score="3"]{color:#eab308}
.stars[data-score="2"]{color:#fb923c}
.stars[data-score="1"]{color:#f87171}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.tag{
  font-size:.65rem;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--muted);
}
.admin-actions{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.admin-actions .btn{padding:4px 10px;font-size:.7rem}

/* Audit panel */
.audit-panel{
  background:var(--card);
  border-radius:var(--radius);
  border:1px solid var(--border);
  padding:10px 12px;
  max-height:560px;
  overflow-y:auto;
  font-size:.75rem;
}
.audit-panel h3{
  margin:0 0 6px;
  font-size:.9rem;
}
.audit-item{
  border-bottom:1px solid rgba(148,163,184,.2);
  padding:4px 0;
}
.audit-item:last-child{border-bottom:none}
.audit-meta{color:var(--muted);font-size:.7rem}

/* Leaderboard chip */
.lb-chip{
  display:inline-block;
  font-size:.7rem;
  padding:1px 7px;
  border-radius:999px;
  border:1px solid rgba(250,204,21,.8);
  color:#fde68a;
  margin-left:6px;
}

/* Modal */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  place-items:center;
  z-index:9998;
}
.modal-box{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px 16px 14px;
  width:100%;
  max-width:380px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.modal-box h3{margin:0 0 4px;font-size:1rem}
.modal-box label{
  font-size:.75rem;
  color:var(--muted);
}
.modal-box input{
  width:100%;
  padding:7px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#020617;
  color:white;
  font-size:.8rem;
}
.modal-actions{
  display:flex;
  justify-content:space-between;
  margin-top:8px;
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <h2>LEADER LOGIN </h2>
    <p>Enter your any name and password to manage the squad roster.</p>
    <input id="loginUser" placeholder="Admin name">
    <input id="loginPass" placeholder="Password" type="password">
    <button onclick="handleLogin()">Login</button>
    <div class="login-error" id="loginError"></div>
    <p style="font-size:0.75rem;color:#6b7280;margin-top:6px;">
      Tip: It is provided to you.
    </p>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="container">
    <h1>Squad Members ‚Äì Admin Pro Dashboard</h1>
    <div class="subtitle">Card View ‚Ä¢ Filters ‚Ä¢ Leaderboard ‚Ä¢ Cloud Ready</div>
    <div class="userline">Logged in as: <span id="currentAdminLabel"></span></div>

    <div class="top-controls">
      <button class="btn success" onclick="openAdd()">‚ûï Add Member</button>
      <button class="btn secondary" onclick="exportCSV()">üì§ Export Excel (CSV)</button>
      <button class="btn secondary" onclick="triggerImport()">üì• Import Excel (CSV)</button>
      <button class="btn secondary" onclick="syncToCloud()">‚òÅ Sync to Firebase</button>
      <button class="btn secondary" onclick="loadFromCloud()">‚¨á Load from Firebase</button>
      <button class="btn danger" onclick="resetData()">‚ôª Reset to Default</button>
    </div>

    <div class="stats">
      <div class="stat">Total: <span id="statTotal">0</span></div>
      <div class="stat">Avg Power: <span id="statAvg">0</span></div>
      <div class="stat">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ: <span id="statFive">0</span></div>
    </div>

    <div class="filter-bar">
      <button class="btn filter" data-filter="TANK" onclick="setFilter(this)">TANK</button>
      <button class="btn filter" data-filter="AIR" onclick="setFilter(this)">AIR</button>
      <button class="btn filter" data-filter="MISSILE" onclick="setFilter(this)">MISSILE</button>
      <button class="btn filter" data-filter="R3" onclick="setFilter(this)">R3</button>
      <button class="btn filter" data-filter="R4" onclick="setFilter(this)">R4</button>
      <button class="btn filter" data-filter="R5" onclick="setFilter(this)">R5</button>
      <button class="btn filter" data-filter="RESET" onclick="setFilter(this)">RESET</button>
    </div>

    <div class="search-box">
      <input type="text" id="search" placeholder="Search name, role or squad...">
    </div>

    <div class="sort-bar">
      <span style="font-size:.78rem;color:var(--muted);margin-right:4px;">Sort:</span>
      <button class="btn secondary" onclick="setSort('power-desc')">Power ‚Üì</button>
      <button class="btn secondary" onclick="setSort('power-asc')">Power ‚Üë</button>
      <button class="btn secondary" onclick="setSort('stars-desc')">Activity ‚òÖ‚Üì</button>
      <button class="btn secondary" onclick="setSort('stars-asc')">Activity ‚òÖ‚Üë</button>
      <button class="btn" onclick="setSort(null)">Clear Sort</button>
      <span class="lb-chip">üèÜ Leaderboard uses Power ‚Üì</span>
    </div>

    <div class="main-layout">
      <div>
        <div class="grid" id="grid"></div>
      </div>
      <div class="audit-panel">
        <h3>Audit History</h3>
        <div id="auditList"></div>
      </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" style="display:none" accept=".csv">
  </div>
</div>

<!-- EDIT/ADD MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Edit Member</h3>
    <label>Name</label>
    <input id="inpName">
    <label>Role (e.g. R3, R4, R5, R4 RECRUITER)</label>
    <input id="inpRole">
    <label>Squad (TANK / AIR / MISSILE / HYBRID or blank)</label>
    <input id="inpSquad">
    <label>Power (number, can be 0)</label>
    <input id="inpPower" type="number" step="0.1">
    <label>Activity Stars (1‚Äì5)</label>
    <input id="inpStars" type="number" min="1" max="5">
    <div class="modal-actions">
      <button class="btn danger" onclick="closeModal()">Cancel</button>
      <button class="btn success" onclick="saveMember()">Save</button>
    </div>
  </div>
</div>

<!-- Firebase (optional, only if you fill config) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// ---------- CONFIG ----------
const ADMIN_PASSWORD = "704admin"; // <--- CHANGE THIS PASSWORD
const FIREBASE_CONFIG = {
  // Fill with your Firebase config to enable cloud sync:
  // apiKey: "",
  // authDomain: "",
  // projectId: "",
  // ...
};

let db = null;
let hasFirebase = false;

// ---------- DATA ----------
const defaultMembers = [
  {n:"Razer",r:"R3",s:"TANK HYBRID",p:51.5,a:2},
  {n:"AkkiÏ†ÑÏÇ¨",r:"R3",s:"TANK HYBRID",p:48.1,a:4},
  {n:"Arbo",r:"R4",s:"TANK",p:48.1,a:2},
  {n:"Beast incarnate",r:"R3",s:"TANK",p:39.9,a:2},
  {n:"sonuvvv",r:"R3",s:"TANK",p:41.1,a:2},
  {n:"CeeMb",r:"R3",s:"TANK",p:44.9,a:4},
  {n:"Ïú†ÎèÑFaFa",r:"R3",s:"TANK",p:38.1,a:1},
  {n:"Î∏îÎ£®Ï∫êÎ°¨(Blue Carrom)Fountain Dance DP",r:"R3",s:"TANK",p:38.1,a:1},
  {n:"Rockarz Roy",r:"R3",s:"TANK",p:43.1,a:3},
  {n:"Painkiller24",r:"R3",s:"TANK",p:37.9,a:1},
  {n:"CK002",r:"R3",s:"TANK",p:35.7,a:3},
  {n:"Chicken Nuggie",r:"R3",s:"TANK",p:37.1,a:3},
  {n:"Astra S",r:"R3",s:"TANK",p:43.1,a:2},
  {n:"drokaris",r:"R3",s:"TANK",p:40.1,a:5},
  {n:"El Jaste",r:"R3",s:"TANK",p:45.9,a:2},
  {n:"Ïö∞ÏÑ± Woosung",r:"R3",s:"TANK",p:43.9,a:2},
  {n:"ÏûÖÏà†Ï†ÑÏÇ¨ joon",r:"R3",s:"TANK",p:45.3,a:3},
  {n:"Elite SKY",r:"R3",s:"TANK",p:44.7,a:3},
  {n:"Queen of Hearts",r:"R3",s:"TANK",p:35.1,a:5},
  {n:"maximus",r:"R3",s:"TANK",p:38.9,a:4},
  {n:"Coconuts",r:"R3",s:"TANK",p:44.1,a:3},
  {n:"ChenU",r:"R3",s:"MISSILE",p:44.3,a:4},
  {n:"King of 704",r:"R3",s:"MISSILE",p:49.1,a:5},
  {n:"Dior ÎîîÏò¨",r:"R5",s:"AIR HYBRID",p:58.4,a:4},
  {n:"Harbin",r:"R4 RECRUITER",s:"AIR",p:53.3,a:5},
  {n:"Snail",r:"R4 MUSE",s:"AIR",p:48.1,a:3},
  {n:"Rahul",r:"R4 BUTLER",s:"AIR",p:62.5,a:4},
  {n:"Reiko13",r:"R3",s:"AIR",p:49.9,a:3},
  {n:"ÎØ∏Îã¥Ìè¨ÌÅ¨(Tale Fork)Pig Snake DP",r:"R3",s:"AIR",p:45.5,a:3},
  {n:"Choudhury",r:"R3",s:"AIR",p:44.9,a:5},
  {n:"Í∑∏ÎÉ•Î∞õÎäîÎã§park",r:"R3",s:"AIR",p:60.5,a:4},
  {n:"ÌÇπÎ∞õÎäîÎã§HOON",r:"R3",s:"AIR",p:59.2,a:4},
  {n:"ÌÉÄÏù¥Í±∞Tiger",r:"R3",s:"AIR",p:46.5,a:4},
  {n:"iamjaycee",r:"R3",s:"AIR",p:43.1,a:2},
  {n:"drizzle",r:"R3",s:"AIR",p:46.1,a:4},
  {n:"ÏÇ∞Ïù¥Ïä¨11beomi",r:"R3",s:"AIR",p:51.5,a:4},
  {n:"TheO",r:"R3",s:"AIR",p:50.9,a:4},
  {n:"Ervvv",r:"R3",s:"AIR",p:49.1,a:4},
  {n:"master",r:"R3",s:"AIR",p:49.8,a:4},
  {n:"Jerista",r:"R3",s:"AIR",p:49.5,a:3},
  {n:"Evans570",r:"R3",s:"AIR",p:45.7,a:3},
  {n:"konamory",r:"R4 WARLORD",s:"",p:0,a:1},
  {n:"WinterFaerie",r:"R4",s:"",p:0,a:3},
  {n:"MIGHTY7",r:"R4",s:"",p:0,a:4},
  {n:"Weeer",r:"R4",s:"",p:0,a:4},
  {n:"Winter Korean",r:"R4",s:"",p:0,a:4},
  {n:"Blade 00007",r:"R3",s:"",p:0,a:1},
  {n:"Anki",r:"R3",s:"",p:0,a:3},
  {n:"BALERION",r:"R3",s:"",p:0,a:1},
  {n:"54321abc",r:"R3",s:"",p:0,a:2},
  {n:"Ironheart25",r:"R3",s:"",p:0,a:4},
  {n:"WJÍ∞êÏ†ïÌèâÍ∞ÄÏóÖÏûê",r:"R3",s:"",p:0,a:2},
  {n:"Ï†úÎ¶¨Jerry",r:"R3",s:"",p:0,a:3},
  {n:"BendOverWarning",r:"R3",s:"",p:0,a:3},
  {n:"MoNoo",r:"R3",s:"",p:0,a:1},
  {n:"Guardian bro",r:"R3",s:"",p:0,a:1},
  {n:"FallingStarVJ",r:"R3",s:"",p:0,a:1},
  {n:"yuD",r:"R3",s:"",p:0,a:3},
  {n:"CIDING",r:"R3",s:"",p:0,a:4},
  {n:"ÍπÄÏû•ÏÑ†Ïß±(Champion)Mountains Sky DP",r:"R3",s:"",p:0,a:3},
  {n:"Î∞òÏû•Ïö©(Class Leader Yong)No DP",r:"R3",s:"",p:0,a:3},
  {n:"Îß§ÎìúMAX",r:"R3",s:"",p:0,a:3},
  {n:"marlboroÌÅ¨Ïïô",r:"R3",s:"",p:0,a:1},
  {n:"Pensicake ÌîºÎãâÏä§",r:"R3",s:"",p:0,a:4},
  {n:"Lil Project",r:"R3",s:"",p:0,a:1},
  {n:"Noname Brother",r:"R3",s:"",p:0,a:3},
  {n:"BlackVodu",r:"R3",s:"",p:0,a:2},
  {n:"Vikkas",r:"R3",s:"",p:0,a:1},
  {n:"Sabreez",r:"R3",s:"",p:0,a:3},
  {n:"Mak go pro",r:"R3",s:"",p:0,a:2},
  {n:"AK550",r:"R3",s:"",p:0,a:1},
  {n:"Ï∞¨ÎìúÎùº(Chandra)Bridge DP",r:"R3",s:"",p:0,a:1},
  {n:"3bandsPapa",r:"R3",s:"",p:0,a:3},
  {n:"Í≥∞ÌÉ±Ïù¥Îã¨Î¥âÏù¥(Dalbong)Sunset DP",r:"R3",s:"",p:0,a:1},
  {n:"Xelestine",r:"R3",s:"",p:0,a:2},
  {n:"NikonianDSev",r:"R3",s:"",p:0,a:3},
  {n:"XXHeadShotXX",r:"R3",s:"",p:0,a:4},
  {n:"Ìô©Íµ∞Ïù¥(Hwang)Cat DP",r:"R3",s:"",p:0,a:2},
  {n:"ÌïúÎ≥µÏù¥ otter",r:"R3",s:"",p:0,a:4},
  {n:"night sky Î∞§ÌïòÎäò",r:"R3",s:"",p:0,a:4},
  {n:"MR Sam",r:"R3",s:"",p:0,a:2},
  {n:"TUUT",r:"R3",s:"",p:0,a:1},
  {n:"ÎÜçÎã¥Í≥∞ÌÉ±Ïù¥v(Bear)thakyou DP",r:"R3",s:"",p:0,a:3},
  {n:"ÏïÑÎÇôÏàòÎùºÎ¨∏(Asura)Tiger Wide DP",r:"R3",s:"",p:0,a:3},
  {n:"Îß§ÎìúDASONI",r:"R3",s:"",p:0,a:4},
  {n:"ÎΩÄÎΩÄÏù¥ otter",r:"R3",s:"",p:0,a:4},
  {n:"Arvind 0009",r:"R3",s:"",p:0,a:5},
  {n:"Î∂àÎ¨¥Î¶¨ 3283",r:"R3",s:"",p:0,a:4},
  {n:"ÏÇ¨ÎπÑÏö∞(Sabi-woo)Dark Path DP",r:"R3",s:"",p:0,a:1},
  {n:"Don",r:"R3",s:"",p:0,a:4},
  {n:"El Gori",r:"R3",s:"",p:0,a:3},
  {n:"Aussie Minion",r:"R3",s:"",p:0,a:4},
  {n:"Papa Brew Pig",r:"R3",s:"",p:0,a:3},
  {n:"ÌÉúÏßÑÌïòÏàô(Taejin)bull DP",r:"R3",s:"",p:0,a:3},
  {n:"lioooo",r:"R3",s:"",p:0,a:2},
  {n:"Sordy",r:"R3",s:"",p:0,a:3},
  {n:"Ìï≠ÌôçÌù•(Hang Hong)Rabbit 2nd DP",r:"R3",s:"",p:0,a:2}
];

let members = [];
let auditLog = [];
let currentAdmin = "Admin";

let state = {
  filter: "RESET",
  search: "",
  sort: null // 'power-desc', 'power-asc', 'stars-desc', 'stars-asc'
};

let editIndex = null;

// DOM refs
const loginScreen = document.getElementById("loginScreen");
const loginUserEl = document.getElementById("loginUser");
const loginPassEl = document.getElementById("loginPass");
const loginErrorEl = document.getElementById("loginError");
const appEl = document.getElementById("app");
const currentAdminLabel = document.getElementById("currentAdminLabel");

const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");
const fileInput = document.getElementById("fileInput");

const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const inpName = document.getElementById("inpName");
const inpRole = document.getElementById("inpRole");
const inpSquad = document.getElementById("inpSquad");
const inpPower = document.getElementById("inpPower");
const inpStars = document.getElementById("inpStars");

const auditList = document.getElementById("auditList");

// Stats labels
const statTotal = document.getElementById("statTotal");
const statAvg = document.getElementById("statAvg");
const statFive = document.getElementById("statFive");

// ---------- LOGIN ----------
function handleLogin(){
  const u = (loginUserEl.value || "").trim() || "Admin";
  const p = loginPassEl.value;

  if(p === ADMIN_PASSWORD){
    currentAdmin = u;
    loginErrorEl.textContent = "";
    localStorage.setItem("adminSession", "1");
    localStorage.setItem("adminName", currentAdmin);
    loginScreen.style.display = "none";
    appEl.style.display = "block";
    currentAdminLabel.textContent = currentAdmin;
    initApp();
  } else {
    loginErrorEl.textContent = "Incorrect password.";
  }
}

(function autoLogin(){
  const sess = localStorage.getItem("adminSession");
  const name = localStorage.getItem("adminName");
  if(sess === "1"){
    currentAdmin = name || "Admin";
    loginScreen.style.display = "none";
    appEl.style.display = "block";
    currentAdminLabel.textContent = currentAdmin;
    initApp();
  }
})();

// ---------- FIREBASE INIT ----------
function initFirebase(){
  try{
    if(!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey) return;
    if(!window.firebase) return;
    if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    hasFirebase = true;
    console.log("Firebase initialized");
  }catch(e){
    console.warn("Firebase init failed:", e);
  }
}

// ---------- STORAGE HELPERS ----------
function loadMembers(){
  const raw = localStorage.getItem("membersDataFull");
  if(raw){
    try{ members = JSON.parse(raw); }
    catch{ members = [...defaultMembers]; }
  } else {
    members = [...defaultMembers];
  }
}

function saveMembers(){
  localStorage.setItem("membersDataFull", JSON.stringify(members));
}

function loadAudit(){
  const raw = localStorage.getItem("membersAuditLog");
  if(raw){
    try{ auditLog = JSON.parse(raw); }
    catch{ auditLog = []; }
  } else auditLog = [];
}

function saveAudit(){
  localStorage.setItem("membersAuditLog", JSON.stringify(auditLog));
}

function addAudit(action, memberName, details){
  const entry = {
    t: new Date().toISOString(),
    admin: currentAdmin,
    action,
    member: memberName,
    details: details || ""
  };
  auditLog.unshift(entry);
  // keep last 200
  auditLog = auditLog.slice(0,200);
  saveAudit();
  renderAudit();
}

// ---------- RENDERING ----------
function stars(n){
  n = Math.max(1, Math.min(5, n || 1));
  return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,n) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0,5-n);
}

function getVisibleMembers(){
  let arr = members.slice();

  // Filter
  if(state.filter && state.filter !== "RESET"){
    const f = state.filter;
    arr = arr.filter(m => ((m.s || "") + (m.r || "")).includes(f));
  }

  // Search
  const q = (state.search || "").toLowerCase();
  if(q){
    arr = arr.filter(m =>
      (m.n + " " + (m.r||"") + " " + (m.s||"")).toLowerCase().includes(q)
    );
  }

  // Sort
  if(state.sort){
    if(state.sort === "power-desc"){
      arr.sort((a,b) => (b.p||0) - (a.p||0));
    } else if(state.sort === "power-asc"){
      arr.sort((a,b) => (a.p||0) - (b.p||0));
    } else if(state.sort === "stars-desc"){
      arr.sort((a,b) => (b.a||0) - (a.a||0));
    } else if(state.sort === "stars-asc"){
      arr.sort((a,b) => (a.a||0) - (b.a||0));
    }
  }

  return arr;
}

function render(){
  const data = getVisibleMembers();
  grid.innerHTML = "";
  let total = 0, sum = 0, five = 0;

  // Leaderboard indicator uses top 10 by power global
  const leaderboard = members
    .slice()
    .sort((a,b)=>(b.p||0)-(a.p||0))
    .slice(0,10)
    .map(m => m.n);

  data.forEach((m,i)=>{
    total++;
    if(m.p) sum += m.p;
    if(m.a === 5) five++;

    const card = document.createElement("div");
    card.className = "card";

    const isLb = leaderboard.includes(m.n);

    card.innerHTML = `
      <div class="name">
        ${m.n}
        ${isLb ? '<span style="font-size:.7rem;margin-left:4px;color:#fbbf24;">üèÜ</span>' : ""}
      </div>
      <div class="power">${m.p || "‚Äî"}</div>
      <div class="stars" data-score="${m.a || 1}">${stars(m.a)}</div>
      <div class="meta">${m.r || "‚Äî"} ‚Ä¢ ${(m.s && m.s.trim()) || "Unassigned"}</div>
      <div class="tags">
        ${m.s ? `<span class="tag">${m.s}</span>` : ""}
        ${m.r ? `<span class="tag">${m.r}</span>` : ""}
      </div>
      <div class="admin-actions">
        <button class="btn" onclick="openEdit(${members.indexOf(m)})">Edit</button>
        <button class="btn danger" onclick="deleteMember(${members.indexOf(m)})">Delete</button>
      </div>
    `;
    grid.appendChild(card);
  });

  statTotal.textContent = total;
  statAvg.textContent = (sum / (total || 1)).toFixed(2);
  statFive.textContent = five;
}

function renderAudit(){
  auditList.innerHTML = "";
  if(!auditLog.length){
    auditList.innerHTML = '<div style="color:var(--muted);font-size:.75rem;">No changes yet.</div>';
    return;
  }
  auditLog.forEach(e=>{
    const div = document.createElement("div");
    div.className = "audit-item";
    const time = new Date(e.t).toLocaleString();
    div.innerHTML = `
      <div><strong>${e.action}</strong> ‚Äì ${e.member || "-"} ${e.details ? " ‚Äî " + e.details : ""}</div>
      <div class="audit-meta">${time} ‚Ä¢ ${e.admin}</div>
    `;
    auditList.appendChild(div);
  });
}

// ---------- UI STATE HANDLERS ----------
function setFilter(btn){
  const value = btn.getAttribute("data-filter");
  state.filter = value;
  document.querySelectorAll(".filter").forEach(b => {
    b.style.borderColor = "#1f2933";
  });
  btn.style.borderColor = "#e5e7eb";
  render();
}

function setSort(mode){
  state.sort = mode;
  render();
}

searchInput.addEventListener("input", ()=>{
  state.search = searchInput.value;
  render();
});

// ---------- MODAL EDIT / ADD ----------
function openEdit(i){
  editIndex = i;
  const m = members[i];
  modalTitle.textContent = "Edit Member";
  inpName.value = m.n;
  inpRole.value = m.r || "";
  inpSquad.value = m.s || "";
  inpPower.value = m.p || "";
  inpStars.value = m.a || 3;
  modal.style.display = "grid";
}

function openAdd(){
  editIndex = null;
  modalTitle.textContent = "Add Member";
  inpName.value = "";
  inpRole.value = "";
  inpSquad.value = "";
  inpPower.value = "";
  inpStars.value = 3;
  modal.style.display = "grid";
}

function closeModal(){
  modal.style.display = "none";
}

function saveMember(){
  const obj = {
    n: inpName.value.trim(),
    r: inpRole.value.trim(),
    s: inpSquad.value.trim(),
    p: parseFloat(inpPower.value) || 0,
    a: Math.max(1, Math.min(5, parseInt(inpStars.value) || 3))
  };
  if(!obj.n){
    alert("Name is required.");
    return;
  }

  if(editIndex === null){
    members.push(obj);
    addAudit("ADD", obj.n, "");
  } else {
    const oldName = members[editIndex].n;
    members[editIndex] = obj;
    addAudit("EDIT", obj.n, oldName !== obj.n ? `Renamed from ${oldName}` : "");
  }
  saveMembers();
  closeModal();
  render();
}

function deleteMember(i){
  if(!confirm("Delete this member?")) return;
  const name = members[i].n;
  members.splice(i,1);
  saveMembers();
  addAudit("DELETE", name, "");
  render();
}

// ---------- RESET ----------
function resetData(){
  if(!confirm("Reset ALL data to default list?")) return;
  members = [...defaultMembers];
  saveMembers();
  addAudit("RESET", "-", "Dataset reset to defaults");
  render();
}

// ---------- EXCEL EXPORT / IMPORT (CSV) ----------
function exportCSV(){
  const headers = ["Name","Role","Squad","Power","Stars"];
  const lines = [headers.join(",")];
  members.forEach(m=>{
    const row = [
      m.n.replace(/,/g," "),
      (m.r||"").replace(/,/g," "),
      (m.s||"").replace(/,/g," "),
      m.p || 0,
      m.a || 1
    ];
    lines.push(row.join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "squad_members.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  addAudit("EXPORT", "-", "Exported to CSV");
}

function triggerImport(){
  fileInput.value = "";
  fileInput.click();
}

fileInput.addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt=>{
    const text = evt.target.result;
    const lines = text.split(/\r?\n/).filter(x=>x.trim());
    const newMembers = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(",");
      if(!cols[0]) continue;
      newMembers.push({
        n: cols[0].trim(),
        r: (cols[1]||"").trim(),
        s: (cols[2]||"").trim(),
        p: parseFloat(cols[3]) || 0,
        a: Math.max(1, Math.min(5, parseInt(cols[4]) || 3))
      });
    }
    if(newMembers.length){
      if(confirm("Replace current list with imported CSV data?")){
        members = newMembers;
        saveMembers();
        addAudit("IMPORT", "-", `Imported ${newMembers.length} records from CSV`);
        render();
      }
    }
  };
  reader.readAsText(file);
});

// ---------- CLOUD SYNC (FIREBASE) ----------
async function syncToCloud(){
  if(!hasFirebase || !db){
    alert("Firebase not configured. Fill FIREBASE_CONFIG in the HTML file.");
    return;
  }
  try{
    await db.collection("squadData").doc("membersRoster").set({
      members,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    addAudit("CLOUD_SYNC", "-", "Pushed roster to Firebase");
    alert("Synced to Firebase.");
  }catch(e){
    console.error(e);
    alert("Firebase sync failed. Check console.");
  }
}

async function loadFromCloud(){
  if(!hasFirebase || !db){
    alert("Firebase not configured. Fill FIREBASE_CONFIG in the HTML file.");
    return;
  }
  try{
    const doc = await db.collection("squadData").doc("membersRoster").get();
    if(!doc.exists){
      alert("No cloud data found.");
      return;
    }
    const data = doc.data();
    if(Array.isArray(data.members)){
      members = data.members;
      saveMembers();
      addAudit("CLOUD_LOAD", "-", `Loaded ${members.length} records from Firebase`);
      render();
      alert("Loaded data from Firebase.");
    } else {
      alert("Cloud data invalid format.");
    }
  }catch(e){
    console.error(e);
    alert("Firebase load failed. Check console.");
  }
}

// ---------- INIT ----------
function initApp(){
  initFirebase();
  loadMembers();
  loadAudit();
  renderAudit();
  render();
}
</script>

</body>
</html>
